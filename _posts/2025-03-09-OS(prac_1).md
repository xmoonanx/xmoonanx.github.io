---
title: "[OS] Operating System Practice(1): Kernel Build"

categories: [CS, Operating System, OS]
tags:
  - [CS, c, cpp, OS, kernel]
toc: true
toc_sticky: true

date: 2025-03-09
last_modified_at: 2025-03-09
---
>π€ μ΄μμ²΄μ  μ‹¤μµ μμ—… μ •λ¦¬

## Build environment
---
>Use virtual machine
>ubuntu version: `24.04LTS`
>kernelμ€ 5.5.13μ„ μ„¤μΉν•΄μ•Όν•¨

## Build process
---
```Shell
# 1. Update Packages and Install Required Packages
sudo apt update && sudo apt upgrade
sudo apt install build-essential libncurses6 libncurses-dev flex bison \
                 bc dwarves pahole libudev-dev libpci-dev \
                 libssl-dev libelf-dev libiberty-dev binutils-dev -y

# 2. Download the desired kernel version and decompress
wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.5.13.tar.xz
tar xvf linux-5.5.13.tar.xz

# 3. Build kernel
cd linux-5.5.13

sudo cp -v /boot/config-$(uname -r) .config
sudo make menuconfig
* 1. Load -> .config
* 2. Save -> .config
* 3. Exit

sudo make -j$(nproc) # <- μ¤λ¥ λ°μƒ
sudo make modules_install
sudo make install

sudo reboot
```

### μ²«λ²μ§Έ μ¤λ¥
---
![alt text](../assets/img/OS/xrealloc.png)
* xrealloc ν•¨μμ—μ„ use-after-free μ¤λ¥κ°€ λ°μƒν•¨

* μ›μΈ 
  * Linux 5.5.13μ€ μµμ‹  gccμ™€ νΈν™λμ§€ μ•μ„ μ μμ

__ν•΄κ²° λ°©μ•__:
gccμ λ²„μ „μ„ 10λ΅ λ‚®μ¶”κΈ°λ΅ κ²°μ •
```shell
# gcc 10 version μ„¤μΉ
sudo apt install gcc-10 g++-10

# gccμ μ°μ„  μμ„ λ³€κ²½
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-10 1 # <-μ°μ„ μμ„λ²νΈ
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-10 1
```

### λ‘λ²μ§Έ μ¤λ¥
---
![alt text](../assets/img/OS/thunk.png)

* objtoolμ΄ `thunk_64.o`λ¥Ό μ²λ¦¬ν•  λ• missing symbol tableμ΄ λ°μƒν•¨

* λ°μƒν•λ” μ΄μ :
  * `objtool`μ΄ **`symbol table`**μ„ ν™•μΈν•λ” κ³Όμ •μ—μ„ **missing symbol table** λ°μƒ 
  * `Makefile.build`μ—μ„ μ¤λ¥κ°€ λ°μƒν• κ²½μ° ν•΄λ‹Ή `.o` νμΌμ„ μ‚­μ ν•λ” κ·μΉ™μ΄ μ μ©λ¨
  * λ”°λΌμ„ `arch/x86/entry/thunk_64.o`κ°€ μ‚­μ λ¨
  
__ν•΄κ²° λ°©μ•__:
`CONFIG_STACK_VALIDATION` λΉ„ν™μ„±ν™”(objtoolμ„ μ‚¬μ©ν•μ—¬ μ‚¬μ©ν•μ—¬ Stack Validationμ„ μν–‰ν• μ§€ κ²°μ •ν•λ” μµμ…)
-> μ „μ²΄ objtool κ²€μ‚¬λ¥Ό μ°νν•μ§€ λ§κ³  **`thunk_64.o`νμΌλ§ μμ™Έ μ²λ¦¬**ν•΄μ„ μ°ν

* `arch/x86/entry/Makefile`μ—μ„ thunk_64.o νμΌμ„ objtool κ²€μ¦μ—μ„ μ μ™Έν•λ„λ΅ νΈμ§‘
```shell
vim arch/x86/entry/Makefile

# SPDX-License-Identifier: GPL-2.0
#
# Makefile for the x86 low level entry code
#

OBJECT_FILES_NON_STANDARD_entry_64_compat.o := y
OBJECT_FILES_NON_STANDARD_thunk_64.o := y # μ¶”κ°€

CFLAGS_syscall_64.o		+= $(call cc-option,-Wno-override-init,)
CFLAGS_syscall_32.o		+= $(call cc-option,-Wno-override-init,)
obj-y				:= entry_$(BITS).o thunk_$(BITS).o syscall_$(BITS).o
obj-y				+= common.o

obj-y				+= vdso/
obj-y				+= vsyscall/

obj-$(CONFIG_IA32_EMULATION)	+= entry_64_compat.o syscall_32.o

CFLAGS_REMOVE_thunk_64.o := -fstack-validation # μ¶”κ°€
```
μ΄ν›„ `sudo make clean`λ΅ μΊμ‹ μ΄κΈ°ν™” ν›„ λ‹¤μ‹ λΉλ“

### μ„Έλ²μ§Έ μ¤λ¥
---
![alt text](../assets/img/OS/canonical.png)
* build κ³Όμ •μ—μ„ `debian/canonical-certs.pem` νμΌμ΄ ν•„μ”ν•μ§€λ§ μ΅΄μ¬ν•μ§€ μ•μ•„μ„ λ°μƒν•λ” μ¤λ¥
* μ΄ νμΌμ€ λ³΄ν†µ λ°°ν¬νμ—μ„ μ κ³µν•λ” μΈμ¦μ„μ΄μ§€λ§, μ»¤λ„ μ†μ¤μ—λ” ν¬ν•¨λμ§€ μ•λ” κ²½μ°κ°€ λ§μ

__ν•΄κ²° λ°©μ•__:
`.config`νμΌμ—μ„ `CONFIG_SYSTEM_TRUSTED_KEYS=""`μΌλ΅ μμ •